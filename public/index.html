<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<!-- ================= REGISTER ================= -->
<section id="register-section" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">Register</h2>
    <form id="register-form" class="space-y-4">
      <input type="text" id="reg-username" placeholder="Username" class="w-full p-3 border rounded-lg" required>
      <input type="password" id="reg-password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
      <button class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Register</button>
    </form>
    <p class="mt-4 text-center">Already have an account? 
      <a href="#" onclick="showLogin()" class="text-blue-600">Login</a>
    </p>
  </div>
</section>

<!-- ================= LOGIN ================= -->
<section id="login-section" class="hidden min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold text-center text-green-600 mb-6">Login</h2>
    <form id="login-form" class="space-y-4">
      <input type="text" id="login-username" placeholder="Username" class="w-full p-3 border rounded-lg" required>
      <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
      <button class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">Login</button>
    </form>
  </div>
</section>

<!-- ================= DASHBOARD ================= -->
<section id="dashboard-section" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-green-50">
  <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-5xl">
    <h2 class="text-2xl font-bold text-center text-green-600 mb-6">Health Dashboard</h2>

    <!-- Add Record Form -->
    <form id="record-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <input type="date" id="date" class="p-2 border rounded-lg" required>
      <input type="number" id="water" placeholder="Water (ml)" class="p-2 border rounded-lg" required>
      <input type="number" id="exercise" placeholder="Exercise (min)" class="p-2 border rounded-lg" required>
      <input type="number" id="sugar" placeholder="Blood Sugar" class="p-2 border rounded-lg" required>
      <button class="col-span-1 md:col-span-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Add Record</button>
    </form>

    <!-- Records Table -->
    <div class="overflow-x-auto">
      <table class="w-full border border-gray-200 rounded-lg">
        <thead class="bg-green-100">
          <tr>
            <th class="p-3">Date</th>
            <th class="p-3">Water (ml)</th>
            <th class="p-3">Exercise (min)</th>
            <th class="p-3">Blood Sugar</th>
            <th class="p-3 text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="records-table" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ================= EDIT MODAL ================= -->
<div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Edit Record</h2>
    <form id="edit-form" class="space-y-4">
      <input type="hidden" id="edit-id">
      <input type="date" id="edit-date" class="w-full p-2 border rounded-lg" required>
      <input type="number" id="edit-water" class="w-full p-2 border rounded-lg" required>
      <input type="number" id="edit-exercise" class="w-full p-2 border rounded-lg" required>
      <input type="number" id="edit-sugar" class="w-full p-2 border rounded-lg" required>
      <div class="flex justify-between">
        <button type="button" onclick="closeEditModal()" class="bg-gray-400 text-white px-4 py-2 rounded-lg">Cancel</button>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const API_URL = "http://localhost:3000/api"; // replace with deployed URL
let token = "";

// Sections
const registerSection = document.getElementById("register-section");
const loginSection = document.getElementById("login-section");
const dashboardSection = document.getElementById("dashboard-section");

function showLogin() {
  registerSection.classList.add("hidden");
  loginSection.classList.remove("hidden");
}
function showDashboard() {
  loginSection.classList.add("hidden");
  dashboardSection.classList.remove("hidden");
  fetchRecords();
}

// ================= AUTH =================
document.getElementById("register-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("reg-username").value;
  const password = document.getElementById("reg-password").value;

  const res = await fetch(`${API_URL}/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  alert(data.message || data.error);
});

document.getElementById("login-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;

  const res = await fetch(`${API_URL}/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  if (data.token) {
    token = data.token;
    showDashboard();
  } else {
    alert(data.error);
  }
});

// ================= DASHBOARD =================
const recordForm = document.getElementById("record-form");
const recordsTable = document.getElementById("records-table");

recordForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const record = {
    date: document.getElementById("date").value,
    water_intake: document.getElementById("water").value,
    exercise_duration: document.getElementById("exercise").value,
    blood_sugar_level: document.getElementById("sugar").value
  };

  const res = await fetch(`${API_URL}/records`, {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
    body: JSON.stringify(record)
  });

  if (res.ok) {
    recordForm.reset();
    fetchRecords();
  }
});

async function fetchRecords() {
  const res = await fetch(`${API_URL}/records`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const records = await res.json();
  recordsTable.innerHTML = "";

  records.forEach(r => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="p-3">${r.date}</td>
      <td class="p-3">${r.water_intake}</td>
      <td class="p-3">${r.exercise_duration}</td>
      <td class="p-3">${r.blood_sugar_level}</td>
      <td class="p-3 text-center space-x-2">
        <button onclick="openEditModal(${r.id}, '${r.date}', ${r.water_intake}, ${r.exercise_duration}, ${r.blood_sugar_level})" class="bg-blue-500 text-white px-2 py-1 rounded">Edit</button>
        <button onclick="deleteRecord(${r.id})" class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
      </td>
    `;
    recordsTable.appendChild(row);
  });
}

async function deleteRecord(id) {
  if (!confirm("Delete this record?")) return;
  await fetch(`${API_URL}/records/${id}`, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${token}` }
  });
  fetchRecords();
}

// ================= EDIT MODAL =================
const editModal = document.getElementById("edit-modal");
function openEditModal(id, date, water, exercise, sugar) {
  document.getElementById("edit-id").value = id;
  document.getElementById("edit-date").value = date;
  document.getElementById("edit-water").value = water;
  document.getElementById("edit-exercise").value = exercise;
  document.getElementById("edit-sugar").value = sugar;
  editModal.classList.remove("hidden");
}
function closeEditModal() {
  editModal.classList.add("hidden");
}
document.getElementById("edit-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("edit-id").value;
  const record = {
    date: document.getElementById("edit-date").value,
    water_intake: document.getElementById("edit-water").value,
    exercise_duration: document.getElementById("edit-exercise").value,
    blood_sugar_level: document.getElementById("edit-sugar").value
  };
  await fetch(`${API_URL}/records/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
    body: JSON.stringify(record)
  });
  closeEditModal();
  fetchRecords();
});
</script>
</body>
</html>
